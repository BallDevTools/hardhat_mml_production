<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSC Testnet Real Transaction Simulator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.8.0/web3.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .card h3 {
            margin-bottom: 20px;
            color: #4c51bf;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4c51bf;
        }

        .btn {
            background: linear-gradient(135deg, #4c51bf 0%, #667eea 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 81, 191, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #fc8181 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169 0%, #68d391 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #d69e2e 0%, #f6e05e 100%);
        }

        .status-card {
            grid-column: 1 / -1;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-item {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .status-item h4 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .status-item p {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4c51bf;
        }

        .log-container {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }

        .log-success {
            background-color: rgba(72, 187, 120, 0.2);
        }

        .log-error {
            background-color: rgba(245, 101, 101, 0.2);
        }

        .log-info {
            background-color: rgba(66, 153, 225, 0.2);
        }

        .log-warning {
            background-color: rgba(236, 201, 75, 0.2);
        }

        .wallet-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .wallet-connected {
            background-color: rgba(72, 187, 120, 0.2);
            color: #22543d;
            border: 2px solid #68d391;
        }

        .wallet-disconnected {
            background-color: rgba(245, 101, 101, 0.2);
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        .network-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .network-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #68d391;
        }

        .network-indicator.disconnected {
            background-color: #fc8181;
        }

        .contract-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #4c51bf;
        }

        .contract-info h4 {
            color: #4c51bf;
            margin-bottom: 10px;
        }

        .contract-info p {
            font-family: monospace;
            font-size: 12px;
            margin: 2px 0;
            word-break: break-all;
        }

        .tx-link {
            color: #4c51bf;
            text-decoration: none;
            font-weight: bold;
        }

        .tx-link:hover {
            text-decoration: underline;
        }

        .balance-info {
            background: #e6fffa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #38a169;
        }

        .error-info {
            background: #fed7d7;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #e53e3e;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🚀 BSC Testnet Real Transaction Simulator</h1>
            <p>Real Transactions on Binance Smart Chain Testnet</p>
        </div>

        <!-- Contract Information -->
        <div class="card">
            <h3>📋 Contract Information</h3>
            <div class="contract-info">
                <h4>Deployed Contracts</h4>
                <p><strong>FakeUSDT:</strong> 0x3e9a38319cEb9adcad4c5a3C0FE2CE8BcA41b741</p>
                <p><strong>CryptoMembershipNFT:</strong> 0x0af92B4De76A9ce10C6D4AE6ea9485F2d32Ba3f0</p>
                <p><strong>Owner:</strong> 0x2D6b2D23730d8737225146e74975B1273Dc005AF</p>
                <p><strong>BSC Testnet Explorer:</strong> <a href="https://testnet.bscscan.com/" target="_blank"
                        class="tx-link">https://testnet.bscscan.com/</a></p>
            </div>
        </div>

        <div class="dashboard">
            <!-- Connection Panel -->
            <div class="card">
                <h3>🔗 Wallet Connection</h3>

                <div id="walletStatus" class="wallet-status wallet-disconnected">
                    Wallet Not Connected
                </div>

                <div class="network-status">
                    <div id="networkIndicator" class="network-indicator disconnected"></div>
                    <span id="networkName">Not Connected</span>
                </div>

                <div id="balanceInfo" class="balance-info" style="display: none;">
                    <p><strong>BNB Balance:</strong> <span id="bnbBalance">0</span> BNB</p>
                    <p><strong>USDT Balance:</strong> <span id="usdtBalance">0</span> USDT</p>
                </div>

                <button class="btn" onclick="connectWallet()">Connect Wallet</button>
                <button class="btn btn-success" onclick="addBSCTestnet()" id="addNetworkBtn">Add BSC Testnet</button>
                <button class="btn btn-warning" onclick="requestTestBNB()" id="faucetBtn" disabled>Request Test
                    BNB</button>
            </div>

            <!-- Contract Actions -->
            <div class="card">
                <h3>🎯 Contract Actions</h3>

                <div class="form-group">
                    <label for="approveAmount">Approve USDT Amount:</label>
                    <input type="number" id="approveAmount" value="1000" min="1" step="0.1">
                </div>

                <div class="form-group">
                    <label for="planId">Plan ID (1-16):</label>
                    <select id="planId">
                        <option value="1">Plan 1 - 1 USDT</option>
                        <option value="2">Plan 2 - 2 USDT</option>
                        <option value="3">Plan 3 - 3 USDT</option>
                        <option value="4">Plan 4 - 4 USDT</option>
                        <option value="5">Plan 5 - 5 USDT</option>
                        <option value="6">Plan 6 - 6 USDT</option>
                        <option value="7">Plan 7 - 7 USDT</option>
                        <option value="8">Plan 8 - 8 USDT</option>
                        <option value="9">Plan 9 - 9 USDT</option>
                        <option value="10">Plan 10 - 10 USDT</option>
                        <option value="11">Plan 11 - 11 USDT</option>
                        <option value="12">Plan 12 - 12 USDT</option>
                        <option value="13">Plan 13 - 13 USDT</option>
                        <option value="14">Plan 14 - 14 USDT</option>
                        <option value="15">Plan 15 - 15 USDT</option>
                        <option value="16">Plan 16 - 16 USDT</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="uplineAddress">Upline Address:</label>
                    <input type="text" id="uplineAddress" placeholder="0x... (Leave empty for owner)" value="">
                </div>

                <button class="btn btn-success" onclick="approveUSDT()" id="approveBtn" disabled>Approve USDT</button>
                <button class="btn" onclick="registerMember()" id="registerBtn" disabled>Register Member</button>
                <button class="btn btn-warning" onclick="upgradePlan()" id="upgradeBtn" disabled>Upgrade Plan</button>
            </div>

            <!-- Real Transaction Status -->
            <div class="card status-card">
                <h3>📊 Real Transaction Status</h3>

                <div class="status-grid">
                    <div class="status-item">
                        <h4>Your Plan ID</h4>
                        <p id="userPlanId">Not Member</p>
                    </div>
                    <div class="status-item">
                        <h4>Total Earnings</h4>
                        <p id="totalEarnings">0 USDT</p>
                    </div>
                    <div class="status-item">
                        <h4>Total Referrals</h4>
                        <p id="totalReferrals">0</p>
                    </div>
                    <div class="status-item">
                        <h4>USDT Allowance</h4>
                        <p id="usdtAllowance">0 USDT</p>
                    </div>
                    <div class="status-item">
                        <h4>Contract Balance</h4>
                        <p id="contractBalance">0 USDT</p>
                    </div>
                    <div class="status-item">
                        <h4>Total NFTs</h4>
                        <p id="totalSupply">0</p>
                    </div>
                </div>

                <button class="btn btn-success" onclick="refreshData()" id="refreshBtn" disabled>Refresh Data</button>
                <button class="btn btn-warning" onclick="getSystemStats()" id="statsBtn" disabled>Get System
                    Stats</button>
            </div>
        </div>

        <!-- Transaction Log -->
        <div class="card">
            <h3>📝 Real Transaction Log</h3>
            <button class="btn" onclick="clearLog()" style="float: right; margin-top: -40px;">Clear Log</button>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">🚀 BSC Testnet Real Transaction Simulator Ready!</div>
                <div class="log-entry log-info">Connect your wallet to BSC Testnet to begin real transactions...</div>
            </div>
        </div>
    </div>

    <script>
        // Real Contract Addresses on BSC Testnet
        const FAKE_USDT_ADDRESS = '0x3e9a38319cEb9adcad4c5a3C0FE2CE8BcA41b741';
        const CRYPTO_MEMBERSHIP_NFT_ADDRESS = '0x0af92B4De76A9ce10C6D4AE6ea9485F2d32Ba3f0';
        const OWNER_ADDRESS = '0x2D6b2D23730d8737225146e74975B1273Dc005AF';

        // Contract ABIs - จะต้องใส่เอง
        const NFT_ABI = [
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_usdtToken",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "initialOwner",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [],
                "name": "AlreadyMember",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "CooldownActive",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ERC721EnumerableForbiddenBatchMint",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "ERC721IncorrectOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ERC721InsufficientApproval",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "approver",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidApprover",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidOperator",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "receiver",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidReceiver",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    }
                ],
                "name": "ERC721InvalidSender",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ERC721NonexistentToken",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "index",
                        "type": "uint256"
                    }
                ],
                "name": "ERC721OutOfBoundsIndex",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "EmptyName",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "EmptyURI",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "InactivePlan",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "InvalidAmount",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "InvalidCycleMembers",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "InvalidDecimals",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "InvalidPlanID",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "InvalidRequest",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "InvalidRequests",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "LowFeeBalance",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "LowFundBalance",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "LowOwnerBalance",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "NextPlanOnly",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "NoPlanImage",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "NoRequest",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "NonTransferable",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "NonexistentToken",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "NotMember",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "NotPaused",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "Paused",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "Plan1Only",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "PriceTooLow",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ReentrancyGuardReentrantCall",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ReentrantTransfer",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "SafeERC20FailedOperation",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ThirtyDayLock",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "TimelockActive",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "TooSoon",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "UplineNotMember",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "UplinePlanLow",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ZeroAddress",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ZeroBalance",
                "type": "error"
            },
            {
                "inputs": [],
                "name": "ZeroPrice",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "approved",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "approved",
                        "type": "bool"
                    }
                ],
                "name": "ApprovalForAll",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "totalOwner",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "totalFee",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "totalFund",
                        "type": "uint256"
                    }
                ],
                "name": "BatchWithdrawalProcessed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "status",
                        "type": "bool"
                    }
                ],
                "name": "ContractPaused",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "EmergencyWithdraw",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "timestamp",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "EmergencyWithdrawInitiated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "timestamp",
                        "type": "uint256"
                    }
                ],
                "name": "EmergencyWithdrawRequested",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "ownerAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "feeAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "fundAmount",
                        "type": "uint256"
                    }
                ],
                "name": "FundsDistributed",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "member",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "refundAmount",
                        "type": "uint256"
                    }
                ],
                "name": "MemberExited",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "member",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "upline",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "planId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "cycleNumber",
                        "type": "uint256"
                    }
                ],
                "name": "MemberRegistered",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "message",
                        "type": "string"
                    }
                ],
                "name": "MembershipMinted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "newURI",
                        "type": "string"
                    }
                ],
                "name": "MetadataUpdated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "planId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "cycleNumber",
                        "type": "uint256"
                    }
                ],
                "name": "NewCycleStarted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "planId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "membersPerCycle",
                        "type": "uint256"
                    }
                ],
                "name": "PlanCreated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "planId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "imageURI",
                        "type": "string"
                    }
                ],
                "name": "PlanDefaultImageSet",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "member",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "oldPlanId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "newPlanId",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "cycleNumber",
                        "type": "uint256"
                    }
                ],
                "name": "PlanUpgraded",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newPriceFeed",
                        "type": "address"
                    }
                ],
                "name": "PriceFeedUpdated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "ReferralPaid",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "newDuration",
                        "type": "uint256"
                    }
                ],
                "name": "TimelockUpdated",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "TransferAttemptBlocked",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "upline",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "downline",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "downlineCurrentPlan",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "downlineTargetPlan",
                        "type": "uint256"
                    }
                ],
                "name": "UplineNotified",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "MAX_MEMBERS_PER_CYCLE",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "TIMELOCK_DURATION",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "components": [
                            {
                                "internalType": "address",
                                "name": "recipient",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "name": "amount",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "balanceType",
                                "type": "uint256"
                            }
                        ],
                        "internalType": "struct CryptoMembershipNFT.WithdrawalRequest[]",
                        "name": "requests",
                        "type": "tuple[]"
                    }
                ],
                "name": "batchWithdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "cancelEmergencyWithdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_price",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "_name",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_membersPerCycle",
                        "type": "uint256"
                    }
                ],
                "name": "createPlan",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "emergencyWithdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "exitMembership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "getApproved",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getContractStatus",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "isPaused",
                        "type": "bool"
                    },
                    {
                        "internalType": "uint256",
                        "name": "totalBalance",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "memberCount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "currentPlanCount",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "hasEmergencyRequest",
                        "type": "bool"
                    },
                    {
                        "internalType": "uint256",
                        "name": "emergencyTimeRemaining",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "getNFTImage",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "imageURI",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "description",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "planId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "createdAt",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_planId",
                        "type": "uint256"
                    }
                ],
                "name": "getPlanCycleInfo",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "currentCycle",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "membersInCurrentCycle",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "membersPerCycle",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_member",
                        "type": "address"
                    }
                ],
                "name": "getReferralChain",
                "outputs": [
                    {
                        "internalType": "address[]",
                        "name": "",
                        "type": "address[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getSystemStats",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "totalMembers",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "totalRevenue",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "totalCommission",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "ownerFunds",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "feeFunds",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "fundFunds",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    }
                ],
                "name": "isApprovedForAll",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "isTokenTransferable",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "pure",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "name": "members",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "upline",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "totalReferrals",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "totalEarnings",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "planId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "cycleNumber",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "registeredAt",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "ownerOf",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "planCycles",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "currentCycle",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "membersInCurrentCycle",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "planDefaultImages",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "plans",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "price",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "membersPerCycle",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "isActive",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "priceFeed",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_planId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "_upline",
                        "type": "address"
                    }
                ],
                "name": "registerMember",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "requestEmergencyWithdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "restartAfterPause",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bytes",
                        "name": "data",
                        "type": "bytes"
                    }
                ],
                "name": "safeTransferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "operator",
                        "type": "address"
                    },
                    {
                        "internalType": "bool",
                        "name": "approved",
                        "type": "bool"
                    }
                ],
                "name": "setApprovalForAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "baseURI",
                        "type": "string"
                    }
                ],
                "name": "setBaseURI",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bool",
                        "name": "_paused",
                        "type": "bool"
                    }
                ],
                "name": "setPaused",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_planId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "string",
                        "name": "_imageURI",
                        "type": "string"
                    }
                ],
                "name": "setPlanDefaultImage",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_planId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "bool",
                        "name": "_isActive",
                        "type": "bool"
                    }
                ],
                "name": "setPlanStatus",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "_priceFeed",
                        "type": "address"
                    }
                ],
                "name": "setPriceFeed",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "bytes4",
                        "name": "interfaceId",
                        "type": "bytes4"
                    }
                ],
                "name": "supportsInterface",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "index",
                        "type": "uint256"
                    }
                ],
                "name": "tokenByIndex",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "tokenImages",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "imageURI",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "name",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "description",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "planId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "createdAt",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "index",
                        "type": "uint256"
                    }
                ],
                "name": "tokenOfOwnerByIndex",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "tokenURI",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "tokenId",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_planId",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "_newMembersPerCycle",
                        "type": "uint256"
                    }
                ],
                "name": "updateMembersPerCycle",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "_newPlanId",
                        "type": "uint256"
                    }
                ],
                "name": "upgradePlan",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "usdtToken",
                "outputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "validateContractBalance",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdrawFeeSystemBalance",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdrawFundBalance",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdrawOwnerBalance",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        const USDT_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "allowance",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "needed",
                        "type": "uint256"
                    }
                ],
                "name": "ERC20InsufficientAllowance",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "balance",
                        "type": "uint256"
                    },
                    {
                        "internalType": "uint256",
                        "name": "needed",
                        "type": "uint256"
                    }
                ],
                "name": "ERC20InsufficientBalance",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "approver",
                        "type": "address"
                    }
                ],
                "name": "ERC20InvalidApprover",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "receiver",
                        "type": "address"
                    }
                ],
                "name": "ERC20InvalidReceiver",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "sender",
                        "type": "address"
                    }
                ],
                "name": "ERC20InvalidSender",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    }
                ],
                "name": "ERC20InvalidSpender",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "Approval",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "Transfer",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    }
                ],
                "name": "allowance",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "spender",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "approve",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "balanceOf",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "decimals",
                "outputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "name",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "transfer",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "value",
                        "type": "uint256"
                    }
                ],
                "name": "transferFrom",
                "outputs": [
                    {
                        "internalType": "bool",
                        "name": "",
                        "type": "bool"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // Global variables
        let web3, currentAccount, nftContract, usdtContract;
        let userMemberData = null;
        let lastRefreshTime = 0;
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;

        // BSC Testnet configuration
        const BSC_TESTNET = {
            chainId: '0x61', // 97 in decimal
            chainName: 'BSC Testnet',
            nativeCurrency: {
                name: 'BNB',
                symbol: 'BNB',
                decimals: 18
            },
            rpcUrls: ['https://bsc-testnet-dataseed.bnbchain.org'],
            blockExplorerUrls: ['https://testnet.bscscan.com/']
        };

        // Connect Wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                logMessage('❌ MetaMask not found! Please install MetaMask.', 'error');
                return;
            }

            try {
                logMessage('🔄 Connecting to MetaMask...', 'info');

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                // Initialize Web3
                web3 = new Web3(window.ethereum);

                // Switch to BSC Testnet
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BSC_TESTNET.chainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await addBSCTestnet();
                    } else {
                        throw switchError;
                    }
                }

                // Get current account
                const accounts = await web3.eth.getAccounts();
                currentAccount = accounts[0];

                // Initialize contracts
                if (NFT_ABI.length > 0) {
                    nftContract = new web3.eth.Contract(NFT_ABI, CRYPTO_MEMBERSHIP_NFT_ADDRESS);
                    logMessage('✅ NFT Contract initialized', 'success');
                    initializeEventListeners();
                } else {
                    logMessage('⚠️ NFT ABI is empty. Some features will be limited.', 'warning');
                }

                usdtContract = new web3.eth.Contract(USDT_ABI, FAKE_USDT_ADDRESS);
                logMessage('✅ USDT Contract initialized', 'success');

                // Update UI
                updateWalletUI();

                // Enable buttons
                document.getElementById('approveBtn').disabled = false;
                document.getElementById('registerBtn').disabled = NFT_ABI.length === 0;
                document.getElementById('upgradeBtn').disabled = NFT_ABI.length === 0;
                document.getElementById('refreshBtn').disabled = false;
                document.getElementById('statsBtn').disabled = NFT_ABI.length === 0;
                document.getElementById('faucetBtn').disabled = false;

                logMessage('✅ Wallet connected successfully!', 'success');
                logMessage(`📍 Account: ${currentAccount}`, 'info');

                // Load initial data
                await loadWalletData();
                startAutoRefresh();

            } catch (error) {
                logMessage(`❌ Connection failed: ${error.message}`, 'error');
            }
        }

        // Update Wallet UI
        function updateWalletUI() {
            document.getElementById('walletStatus').textContent = `Connected: ${shortenAddress(currentAccount)}`;
            document.getElementById('walletStatus').className = 'wallet-status wallet-connected';
            document.getElementById('networkIndicator').className = 'network-indicator';
            document.getElementById('networkName').textContent = 'BSC Testnet';
        }

        // Shorten Address for display
        function shortenAddress(address) {
            if (!address) return "";
            return `${address.slice(0, 8)}...${address.slice(-4)}`;
        }

        // Add BSC Testnet to MetaMask
        async function addBSCTestnet() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [BSC_TESTNET],
                });
                logMessage('✅ BSC Testnet added to MetaMask', 'success');
            } catch (error) {
                logMessage(`❌ Failed to add BSC Testnet: ${error.message}`, 'error');
            }
        }

        // Request Test BNB from Faucet
        async function requestTestBNB() {
            logMessage('💰 Requesting test BNB from faucet...', 'info');
            logMessage('🔗 Visit: https://testnet.binance.org/faucet-smart', 'info');
            logMessage(`📋 Your address: ${currentAccount}`, 'info');
            logMessage('💡 Copy your address and request 0.1 BNB from the faucet', 'warning');

            // Open faucet in new tab
            window.open('https://testnet.binance.org/faucet-smart', '_blank');
        }

        // Format amount with appropriate decimals
        function formatAmount(amount, decimals) {
            if (!amount) return "0";
            // แปลงเป็น string ก่อนส่งไปให้ web3.utils.fromWei
            const formatted = decimals == 18
                ? web3.utils.fromWei(amount.toString(), 'ether')
                : web3.utils.fromWei(amount.toString(), 'mwei');
            return parseFloat(formatted).toFixed(2);
        }

        // Load Wallet Data
        async function loadWalletData() {
            try {
                if (!web3 || !currentAccount) {
                    return;
                }

                lastRefreshTime = Date.now();

                // Get BNB balance
                const bnbBalance = await web3.eth.getBalance(currentAccount);
                const bnbFormatted = web3.utils.fromWei(bnbBalance, 'ether');
                document.getElementById('bnbBalance').textContent = parseFloat(bnbFormatted).toFixed(4);

                // Get USDT balance
                const usdtBalance = await usdtContract.methods.balanceOf(currentAccount).call();
                const usdtDecimals = await usdtContract.methods.decimals().call();
                const usdtFormatted = formatAmount(usdtBalance, usdtDecimals);
                document.getElementById('usdtBalance').textContent = usdtFormatted;

                // Get USDT allowance
                const allowance = await usdtContract.methods.allowance(currentAccount, CRYPTO_MEMBERSHIP_NFT_ADDRESS).call();
                const allowanceFormatted = formatAmount(allowance, usdtDecimals);
                document.getElementById('usdtAllowance').textContent = allowanceFormatted;

                // Show balance info
                document.getElementById('balanceInfo').style.display = 'block';

                // Load member data if NFT contract is available
                if (nftContract) {
                    await loadMemberData();
                }

                logMessage('📊 Wallet data loaded successfully', 'success');

            } catch (error) {
                logMessage(`❌ Failed to load wallet data: ${error.message}`, 'error');
            }
        }

        // Load Member Data
        async function loadMemberData() {
            try {
                if (!nftContract) {
                    logMessage('⚠️ NFT Contract ABI not loaded', 'warning');
                    return;
                }

                // Check if user is a member
                const balance = await nftContract.methods.balanceOf(currentAccount).call();

                if (balance > 0) {
                    // Get member data
                    const memberData = await nftContract.methods.members(currentAccount).call();
                    userMemberData = memberData;

                    document.getElementById('userPlanId').textContent = memberData.planId;

                    const usdtDecimals = await usdtContract.methods.decimals().call();
                    const earningsFormatted = formatAmount(memberData.totalEarnings, usdtDecimals);

                    document.getElementById('totalEarnings').textContent = `${earningsFormatted} USDT`;
                    document.getElementById('totalReferrals').textContent = memberData.totalReferrals;

                    // Update upgrade button state
                    document.getElementById('upgradeBtn').disabled = false;

                    logMessage(`✅ Member data loaded - Plan ${memberData.planId}`, 'success');
                } else {
                    document.getElementById('userPlanId').textContent = 'Not Member';
                    document.getElementById('totalEarnings').textContent = '0 USDT';
                    document.getElementById('totalReferrals').textContent = '0';

                    // Disable upgrade button for non-members
                    document.getElementById('upgradeBtn').disabled = true;

                    logMessage('ℹ️ You are not a member yet', 'info');
                }

                // Get total supply
                const totalSupply = await nftContract.methods.totalSupply().call();
                document.getElementById('totalSupply').textContent = totalSupply;

                // Get contract balance
                const contractBalance = await usdtContract.methods.balanceOf(CRYPTO_MEMBERSHIP_NFT_ADDRESS).call();
                const usdtDecimals = await usdtContract.methods.decimals().call();
                const contractBalanceFormatted = formatAmount(contractBalance, usdtDecimals);
                document.getElementById('contractBalance').textContent = `${contractBalanceFormatted} USDT`;

            } catch (error) {
                logMessage(`⚠️ Could not load member data: ${error.message}`, 'warning');
            }
        }

        // Approve USDT
        async function approveUSDT() {
            try {
                if (!currentAccount) {
                    throw new Error('Wallet not connected');
                }

                const amount = document.getElementById('approveAmount').value;
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('Invalid amount');
                }

                logMessage(`🔄 Approving ${amount} USDT...`, 'info');

                // ใช้วิธีที่ง่ายที่สุด: ขอ decimals แล้วคำนวณโดยตรง
                const decimals = parseInt(await usdtContract.methods.decimals().call());
                console.log("Decimals:", decimals);

                // คำนวณ amount * 10^decimals ให้ได้จำนวนที่ถูกต้อง
                const amountFloat = parseFloat(amount);
                let amountWei;

                // วิธีที่ 1: ใช้ toWei สำหรับค่าที่รองรับ
                if (decimals === 18) {
                    amountWei = web3.utils.toWei(amount.toString(), 'ether');
                } else if (decimals === 6) {
                    amountWei = web3.utils.toWei(amount.toString(), 'mwei');
                } else {
                    // วิธีที่ 2: ใช้วิธีคำนวณธรรมดาสำหรับค่าอื่นๆ
                    // ใช้ String เพื่อหลีกเลี่ยงปัญหา floating point
                    const multiplier = Math.pow(10, decimals);
                    amountWei = (amountFloat * multiplier).toFixed(0).toString();
                }

                console.log("Approving amount:", amountFloat, "as Wei:", amountWei);

                // ส่งค่าเป็น string
                const gasEstimate = await usdtContract.methods.approve(
                    CRYPTO_MEMBERSHIP_NFT_ADDRESS,
                    amountWei
                ).estimateGas({ from: currentAccount });

                // แปลง gasEstimate เป็น Number ก่อนคำนวณ
                const gasWithBuffer = Math.floor(Number(gasEstimate) * 1.2);

                const tx = await usdtContract.methods.approve(
                    CRYPTO_MEMBERSHIP_NFT_ADDRESS,
                    amountWei
                ).send({
                    from: currentAccount,
                    gas: gasWithBuffer
                });

                logMessage(`✅ USDT approved successfully!`, 'success');
                logMessage(`📋 TX Hash: ${tx.transactionHash}`, 'info');

                // สร้างและแสดงลิงก์ transaction
                const txLink = createTxLink(tx.transactionHash);
                const lastLogEntry = document.querySelector('#logContainer .log-entry:last-child');
                lastLogEntry.appendChild(document.createElement('br'));
                lastLogEntry.appendChild(txLink);

                // Refresh data
                await loadWalletData();

            } catch (error) {
                console.error("Approval error details:", error);
                logMessage(`❌ Approval failed: ${error.message}`, 'error');
            }
        }

        // Create transaction link element
        function createTxLink(txHash) {
            const txLink = document.createElement('a');
            txLink.href = `https://testnet.bscscan.com/tx/${txHash}`;
            txLink.textContent = `View on BSCScan`;
            txLink.className = 'tx-link';
            txLink.target = '_blank';
            return txLink;
        }

        // Register Member
        async function registerMember() {
            try {
                if (!nftContract) {
                    throw new Error('NFT Contract ABI not loaded');
                }

                if (!currentAccount) {
                    throw new Error('Wallet not connected');
                }

                const planId = document.getElementById('planId').value;
                let upline = document.getElementById('uplineAddress').value.trim();

                if (!upline || upline === '') {
                    upline = OWNER_ADDRESS;
                }

                logMessage(`🔄 Registering for Plan ${planId} with upline ${shortenAddress(upline)}...`, 'info');

                // Check USDT allowance
                const usdtDecimals = parseInt(await usdtContract.methods.decimals().call());
                const allowance = await usdtContract.methods.allowance(currentAccount, CRYPTO_MEMBERSHIP_NFT_ADDRESS).call();

                // Get plan price
                const plan = await nftContract.methods.plans(planId).call();
                const planPrice = plan.price;

                console.log("Allowance:", allowance, "Type:", typeof allowance);
                console.log("Plan Price:", planPrice, "Type:", typeof planPrice);

                // แปลงเป็น string และแปลงเป็น BigInt อย่างชัดเจน
                if (BigInt(allowance.toString()) < BigInt(planPrice.toString())) {
                    logMessage(`⚠️ Insufficient USDT allowance. Please approve at least ${formatAmount(planPrice, usdtDecimals)} USDT first.`, 'warning');
                    return;
                }

                const gasEstimate = await nftContract.methods.registerMember(planId, upline)
                    .estimateGas({ from: currentAccount });

                console.log("Gas estimate:", gasEstimate, "Type:", typeof gasEstimate);

                // ปรับการคำนวณ gas โดยแปลงเป็น Number ก่อน
                const gasWithBuffer = Math.floor(Number(gasEstimate) * 1.2);

                const tx = await nftContract.methods.registerMember(planId, upline)
                    .send({
                        from: currentAccount,
                        gas: gasWithBuffer
                    });

                logMessage(`✅ Registration successful!`, 'success');
                logMessage(`📋 TX Hash: ${tx.transactionHash}`, 'info');
                logMessage(`⛽ Gas used: ${tx.gasUsed}`, 'info');

                const txLink = createTxLink(tx.transactionHash);

                const lastLogEntry = document.querySelector('#logContainer .log-entry:last-child');
                lastLogEntry.appendChild(document.createElement('br'));
                lastLogEntry.appendChild(txLink);

                // Refresh data
                await loadWalletData();

            } catch (error) {
                console.error("Registration error details:", error);
                logMessage(`❌ Registration failed: ${error.message}`, 'error');
            }
        }

        // Upgrade Plan
        async function upgradePlan() {
            try {
                if (!nftContract) {
                    throw new Error('NFT Contract ABI not loaded');
                }

                if (!currentAccount) {
                    throw new Error('Wallet not connected');
                }

                if (!userMemberData) {
                    throw new Error('You are not a member yet');
                }

                const currentPlanId = parseInt(userMemberData.planId);
                const newPlanId = currentPlanId + 1;

                if (newPlanId > 16) {
                    throw new Error('Already at maximum plan level');
                }

                logMessage(`🔄 Upgrading from Plan ${currentPlanId} to Plan ${newPlanId}...`, 'info');

                // Check if plan is active
                const plan = await nftContract.methods.plans(newPlanId).call();
                if (!plan.isActive) {
                    throw new Error(`Plan ${newPlanId} is not active`);
                }

                // Calculate price difference
                const usdtDecimals = parseInt(await usdtContract.methods.decimals().call());
                const currentPlanPrice = await nftContract.methods.plans(currentPlanId).call().then(plan => plan.price);
                const newPlanPrice = plan.price;

                console.log("Current Plan Price:", currentPlanPrice, "Type:", typeof currentPlanPrice);
                console.log("New Plan Price:", newPlanPrice, "Type:", typeof newPlanPrice);

                // แปลงเป็น string ก่อนแปลงเป็น BigInt
                const priceDifference = (BigInt(newPlanPrice.toString()) - BigInt(currentPlanPrice.toString())).toString();
                console.log("Price Difference:", priceDifference);

                // Check USDT allowance
                const allowance = await usdtContract.methods.allowance(currentAccount, CRYPTO_MEMBERSHIP_NFT_ADDRESS).call();
                console.log("Allowance:", allowance, "Type:", typeof allowance);

                // แปลงเป็น string ก่อนแปลงเป็น BigInt
                if (BigInt(allowance.toString()) < BigInt(priceDifference.toString())) {
                    logMessage(`⚠️ Insufficient USDT allowance. Please approve at least ${formatAmount(priceDifference, usdtDecimals)} USDT first.`, 'warning');
                    return;
                }

                const gasEstimate = await nftContract.methods.upgradePlan(newPlanId)
                    .estimateGas({ from: currentAccount });

                console.log("Gas estimate:", gasEstimate, "Type:", typeof gasEstimate);

                // ปรับการคำนวณ gas
                const gasWithBuffer = Math.floor(Number(gasEstimate) * 1.2);

                const tx = await nftContract.methods.upgradePlan(newPlanId)
                    .send({
                        from: currentAccount,
                        gas: gasWithBuffer
                    });

                logMessage(`✅ Plan upgrade successful!`, 'success');
                logMessage(`📋 TX Hash: ${tx.transactionHash}`, 'info');
                logMessage(`⛽ Gas used: ${tx.gasUsed}`, 'info');

                const txLink = createTxLink(tx.transactionHash);

                const lastLogEntry = document.querySelector('#logContainer .log-entry:last-child');
                lastLogEntry.appendChild(document.createElement('br'));
                lastLogEntry.appendChild(txLink);

                // Refresh data
                await loadWalletData();

            } catch (error) {
                console.error("Upgrade error details:", error);
                logMessage(`❌ Plan upgrade failed: ${error.message}`, 'error');
            }
        }

        function safeToString(value) {
            if (value === null || value === undefined) return '0';
            return value.toString();
        }

        // Get System Stats
        async function getSystemStats() {
            try {
                if (!nftContract) {
                    throw new Error('NFT Contract ABI not loaded');
                }

                logMessage('🔄 Loading system statistics...', 'info');

                const stats = await nftContract.methods.getSystemStats().call();
                const contractBalance = await usdtContract.methods.balanceOf(CRYPTO_MEMBERSHIP_NFT_ADDRESS).call();
                const decimals = await usdtContract.methods.decimals().call();

                const contractBalanceFormatted = formatAmount(contractBalance, decimals);
                const totalRevenueFormatted = formatAmount(stats.totalRevenue, decimals);
                const totalCommissionFormatted = formatAmount(stats.totalCommission, decimals);
                const ownerFundsFormatted = formatAmount(stats.ownerFunds, decimals);
                const feeFundsFormatted = formatAmount(stats.feeFunds, decimals);
                const fundFundsFormatted = formatAmount(stats.fundFunds, decimals);

                document.getElementById('contractBalance').textContent = contractBalanceFormatted + " USDT";
                document.getElementById('totalSupply').textContent = stats.totalMembers;

                logMessage('📊 System Statistics:', 'success');
                logMessage(`   Total Members: ${stats.totalMembers}`, 'info');
                logMessage(`   Total Revenue: ${totalRevenueFormatted} USDT`, 'info');
                logMessage(`   Total Commission: ${totalCommissionFormatted} USDT`, 'info');
                logMessage(`   Owner Funds: ${ownerFundsFormatted} USDT`, 'info');
                logMessage(`   Fee Funds: ${feeFundsFormatted} USDT`, 'info');
                logMessage(`   Fund Balance: ${fundFundsFormatted} USDT`, 'info');

            } catch (error) {
                logMessage(`❌ Failed to get system stats: ${error.message}`, 'error');
            }
        }

        // Refresh Data
        async function refreshData() {
            try {
                logMessage('🔄 Refreshing all data...', 'info');
                await loadWalletData();
                logMessage('✅ Data refreshed successfully', 'success');
            } catch (error) {
                logMessage(`❌ Failed to refresh data: ${error.message}`, 'error');
            }
        }

        // Log Message
        function logMessage(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Clear Log
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry log-info">📝 Log cleared</div>';
        }

        // Check Transaction Status
        async function checkTransactionStatus(txHash) {
            try {
                const receipt = await web3.eth.getTransactionReceipt(txHash);
                if (receipt) {
                    if (receipt.status) {
                        logMessage(`✅ Transaction ${txHash.slice(0, 10)}... confirmed`, 'success');
                    } else {
                        logMessage(`❌ Transaction ${txHash.slice(0, 10)}... failed`, 'error');
                    }
                    return receipt;
                } else {
                    logMessage(`⏳ Transaction ${txHash.slice(0, 10)}... pending`, 'warning');
                    return null;
                }
            } catch (error) {
                logMessage(`❌ Failed to check transaction status: ${error.message}`, 'error');
                return null;
            }
        }

        // Wait For Transaction
        async function waitForTransaction(txHash, timeout = 60000) {
            const startTime = Date.now();

            while (Date.now() - startTime < timeout) {
                const receipt = await checkTransactionStatus(txHash);
                if (receipt) {
                    return receipt;
                }
                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
            }

            throw new Error('Transaction timeout');
        }

        // Gas estimation helper
        async function estimateGasWithBuffer(contractMethod, fromAddress, bufferPercent = 20) {
            try {
                const gasEstimate = await contractMethod.estimateGas({ from: fromAddress });
                const gasWithBuffer = Math.floor(gasEstimate * (1 + bufferPercent / 100));
                logMessage(`⛽ Gas estimate: ${gasEstimate}, with buffer: ${gasWithBuffer}`, 'info');
                return gasWithBuffer;
            } catch (error) {
                logMessage(`⚠️ Gas estimation failed: ${error.message}`, 'warning');
                return 300000; // Default gas limit
            }
        }

        // Setup Contract Event Listeners
        function setupEventListeners() {
            if (!nftContract) return;

            try {
                // Listen for MemberRegistered events
                nftContract.events.MemberRegistered({
                    fromBlock: 'latest'
                })
                    .on('data', (event) => {
                        const { member, upline, planId } = event.returnValues;
                        logMessage(`🎉 New member registered: ${shortenAddress(member)} (Plan ${planId})`, 'success');
                        refreshData();
                    })
                    .on('error', (error) => {
                        logMessage(`❌ Event listener error: ${error.message}`, 'error');
                    });

                // Listen for PlanUpgraded events
                nftContract.events.PlanUpgraded({
                    fromBlock: 'latest'
                })
                    .on('data', (event) => {
                        const { member, oldPlanId, newPlanId } = event.returnValues;
                        logMessage(`⬆️ Plan upgraded: ${shortenAddress(member)} (${oldPlanId} → ${newPlanId})`, 'success');
                        refreshData();
                    })
                    .on('error', (error) => {
                        logMessage(`❌ Event listener error: ${error.message}`, 'error');
                    });

                // Listen for ReferralPaid events
                nftContract.events.ReferralPaid({
                    fromBlock: 'latest'
                })
                    .on('data', (event) => {
                        const { from, to, amount } = event.returnValues;
                        const decimals = 18; // Assuming USDT decimals
                        const amountFormatted = formatAmount(amount, decimals);
                        logMessage(`💸 Referral paid: ${shortenAddress(from)} → ${shortenAddress(to)} (${amountFormatted} USDT)`, 'success');
                    })
                    .on('error', (error) => {
                        logMessage(`❌ Event listener error: ${error.message}`, 'error');
                    });

                // Listen for NewCycleStarted events
                nftContract.events.NewCycleStarted({
                    fromBlock: 'latest'
                })
                    .on('data', (event) => {
                        const { planId, cycleNumber } = event.returnValues;
                        logMessage(`🔄 New cycle started for Plan ${planId}: Cycle #${cycleNumber}`, 'info');
                    })
                    .on('error', (error) => {
                        logMessage(`❌ Event listener error: ${error.message}`, 'error');
                    });

                logMessage('👂 Event listeners setup successfully', 'success');
            } catch (error) {
                logMessage(`⚠️ Failed to setup event listeners: ${error.message}`, 'warning');
            }
        }

        // Initialize Event Listeners
        function initializeEventListeners() {
            if (nftContract && NFT_ABI.length > 0) {
                setupEventListeners();
            }
        }

        // Auto-refresh data every 30 seconds
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }

            isAutoRefreshing = true;

            autoRefreshInterval = setInterval(async () => {
                if (currentAccount && web3) {
                    try {
                        await loadWalletData();
                        // We don't log here to avoid cluttering the log
                    } catch (error) {
                        // Silently handle auto-refresh errors
                        console.error("Auto-refresh error:", error);
                    }
                }
            }, 30000); // 30 seconds
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                isAutoRefreshing = false;
            }
        }

        // Handle wallet events
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    // Wallet disconnected
                    document.getElementById('walletStatus').textContent = 'Wallet Not Connected';
                    document.getElementById('walletStatus').className = 'wallet-status wallet-disconnected';
                    document.getElementById('networkIndicator').className = 'network-indicator disconnected';
                    document.getElementById('networkName').textContent = 'Not Connected';
                    document.getElementById('balanceInfo').style.display = 'none';

                    // Disable buttons
                    document.getElementById('approveBtn').disabled = true;
                    document.getElementById('registerBtn').disabled = true;
                    document.getElementById('upgradeBtn').disabled = true;
                    document.getElementById('refreshBtn').disabled = true;
                    document.getElementById('statsBtn').disabled = true;
                    document.getElementById('faucetBtn').disabled = true;

                    logMessage('🔌 Wallet disconnected', 'warning');

                    // Reset variables
                    web3 = null;
                    currentAccount = null;
                    nftContract = null;
                    usdtContract = null;
                    userMemberData = null;

                    // Stop auto-refresh
                    stopAutoRefresh();
                } else {
                    logMessage('🔄 Account changed, reconnecting...', 'info');
                    connectWallet();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                if (chainId !== BSC_TESTNET.chainId) {
                    logMessage('⚠️ Please switch to BSC Testnet', 'warning');
                    document.getElementById('networkIndicator').className = 'network-indicator disconnected';
                    document.getElementById('networkName').textContent = 'Wrong Network';

                    // Disable buttons when on wrong network
                    document.getElementById('approveBtn').disabled = true;
                    document.getElementById('registerBtn').disabled = true;
                    document.getElementById('upgradeBtn').disabled = true;
                    document.getElementById('refreshBtn').disabled = true;
                    document.getElementById('statsBtn').disabled = true;
                } else {
                    logMessage('✅ Connected to BSC Testnet', 'success');
                    document.getElementById('networkIndicator').className = 'network-indicator';
                    document.getElementById('networkName').textContent = 'BSC Testnet';

                    // Re-enable buttons
                    document.getElementById('approveBtn').disabled = false;
                    document.getElementById('registerBtn').disabled = NFT_ABI.length === 0;
                    document.getElementById('upgradeBtn').disabled = NFT_ABI.length === 0 || !userMemberData;
                    document.getElementById('refreshBtn').disabled = false;
                    document.getElementById('statsBtn').disabled = NFT_ABI.length === 0;
                    document.getElementById('faucetBtn').disabled = false;
                }
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            logMessage('🎯 BSC Testnet Real Transaction Simulator Ready!', 'info');
            logMessage('💡 Important Notes:', 'warning');
            logMessage('1. Make sure you have BNB for gas fees', 'info');
            logMessage('2. Make sure you have USDT tokens', 'info');
            logMessage('3. ABI arrays are empty - you need to fill them', 'warning');
            logMessage('4. All transactions will be real and visible on BSC Testnet!', 'info');

            if (typeof window.ethereum === 'undefined') {
                logMessage('❌ MetaMask not detected', 'error');
                logMessage('📥 Please install MetaMask: https://metamask.io', 'info');
            } else {
                logMessage('✅ MetaMask detected - Ready to connect!', 'success');
            }

            // Check if ABIs are loaded
            if (NFT_ABI.length === 0) {
                logMessage('⚠️ NFT_ABI is empty - Please add the contract ABI', 'warning');
                logMessage('📝 Add ABI to enable contract interactions', 'info');
            } else {
                logMessage('✅ NFT ABI loaded', 'success');
            }

            if (USDT_ABI.length >= 4) {
                logMessage('✅ ERC20 ABI loaded for USDT', 'success');
            }
        });

        // Stop auto-refresh when page is hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
            } else if (currentAccount && web3) {
                startAutoRefresh();
            }
        });

        // Export functions for debugging
        window.bscTestnetDebug = {
            getWeb3: () => web3,
            getCurrentAccount: () => currentAccount,
            getContracts: () => ({ nftContract, usdtContract }),
            getUserMemberData: () => userMemberData,
            getContractAddresses: () => ({
                usdt: FAKE_USDT_ADDRESS,
                nft: CRYPTO_MEMBERSHIP_NFT_ADDRESS,
                owner: OWNER_ADDRESS
            }),
            logMessage: logMessage,
            clearLog: clearLog,
            loadWalletData: loadWalletData,
            loadMemberData: loadMemberData,
            checkTransactionStatus: checkTransactionStatus,
            estimateGasWithBuffer: estimateGasWithBuffer,
            formatAmount: formatAmount,
            shortenAddress: shortenAddress
        };
    </script>
</body>

</html>